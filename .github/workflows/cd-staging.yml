name: CD staging

env:
  KEYWORD: ${{ inputs.keyword }}

on:
  workflow_dispatch:
    inputs:
      keyword:
        type: choice
        description: keyword
        required: true
        default: cherry
        options:
          - cherry
          - dekopon

jobs:
  preprocess:
    runs-on: ubuntu-latest
    outputs:
      COMMIT_MESSAGE: ${{ steps.set_up_commit_message.outputs.COMMIT_MESSAGE }}
    steps:
      - uses: actions/checkout@v4
      - name: Set Up environment Variables
        id: set_up_commit_message
        run: echo "COMMIT_MESSAGE=$(git show -s --format=%s)" >> "$GITHUB_OUTPUT"

  build-hello:
    needs: [preprocess]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run a one-line script
        run: echo Hello, world!

  build-fruit:
    needs: [preprocess]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run a one-line script
        run: echo Hello, ${{ inputs.keyword }}!

  check-deploy:
    needs: [build-hello, build-fruit]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check keyword
        run: bash validate-keyword-staging.sh

  deploy-hello:
    needs: [check-deploy]
    runs-on: ubuntu-latest
    environment:
      name: staging-hello
    steps:
      - uses: actions/checkout@v4
      - name: Run a multi-line script
        run: |
          echo Add other actions to build,
          echo test, and deploy your project.
          echo ${{ needs.preprocess.outputs.COMMIT_MESSAGE }}
          echo $KEYWORD

  deploy-fruit:
    needs: [check-deploy]
    runs-on: ubuntu-latest
    environment:
      name: staging-fruit
    steps:
      - uses: actions/checkout@v4
      - name: Run a multi-line script
        run: |
          echo Add other actions to build,
          echo test, and deploy ${{ inputs.keyword }}.
